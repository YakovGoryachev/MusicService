{% extends 'music/base.html' %}

{% block title %}Профиль - Музыкальный Сервис{% endblock %}

{% block content %}
<div class="container">
    {% csrf_token %}
    <!-- Заголовок профиля -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <div class="profile-avatar mb-3">
                                {% if user.photo_url %}
                                    <img src="{{ user.photo_url }}" class="rounded-circle" alt="Фото профиля" style="width: 120px; height: 120px; object-fit: cover;">
                                {% else %}
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 120px; height: 120px;">
                                        <i class="fas fa-user fa-3x text-white"></i>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h1 class="h2 mb-2">
                                {{ user.login }}
                                {% if user.role == 'admin' %}
                                    <span class="badge bg-danger align-middle ms-2" title="Администратор">Администратор</span>
                                {% else %}
                                    <span class="badge bg-secondary align-middle ms-2" title="Пользователь">Пользователь</span>
                                {% endif %}
                            </h1>
                            {% if user.first_name or user.last_name %}
                                <p class="lead mb-2">
                                    {% if user.first_name %}{{ user.first_name }}{% endif %}
                                    {% if user.last_name %}{{ user.last_name }}{% endif %}
                                </p>
                            {% endif %}
                            <p class="text-muted mb-2">
                                <i class="fas fa-calendar me-2"></i>
                                На сайте с {{ user.date_joined|date:"d.m.Y" }}
                            </p>
                            <p class="text-muted mb-0">
                                <i class="fas fa-envelope me-2"></i>
                                {{ user.email }}
                            </p>
                        </div>
                        <div class="col-md-3">
                            <div class="d-grid gap-2">
                                <a href="#" class="btn btn-outline-primary" onclick="editProfile()">
                                    <i class="fas fa-edit me-2"></i>Редактировать
                                </a>
                                <a href="#" class="btn btn-outline-secondary" onclick="changePassword()">
                                    <i class="fas fa-key me-2"></i>Сменить пароль
                                </a>
                                <button class="btn btn-outline-warning" onclick="toggleAdminRole()" id="toggleAdminBtn">
                                    <i class="fas fa-user-shield me-2"></i>
                                    <span id="toggleAdminText">
                                        {% if user.role == 'admin' %}
                                            Убрать админ права
                                        {% else %}
                                            Сделать администратором
                                        {% endif %}
                                    </span>
                                </button>
                                {% if user.role == 'admin' %}
                                    <a href="{% url 'music:admin_panel' %}" class="btn btn-outline-success">
                                        <i class="fas fa-cog me-2"></i>Админ панель
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Статистика пользователя -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="h5 mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Статистика
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3 mb-3">
                            <div class="border-end">
                                <h4 class="text-primary mb-1">{{ playlists_count }}</h4>
                                <small class="text-muted">Плейлистов</small>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="border-end">
                                <h4 class="text-success mb-1">{{ total_tracks }}</h4>
                                <small class="text-muted">Треков в плейлистах</small>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="border-end">
                                <h4 class="text-info mb-1">{{ total_duration|floatformat:0 }}</h4>
                                <small class="text-muted">Общая длительность (сек)</small>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <h4 class="text-warning mb-1">{{ total_play_count|default:0 }}</h4>
                            <small class="text-muted">Прослушиваний</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Последние плейлисты -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="h5 mb-0">
                        <i class="fas fa-playlist me-2"></i>Последние плейлисты
                    </h3>
                    <a href="{% url 'music:my_playlists' %}" class="btn btn-outline-primary btn-sm">
                        Все плейлисты <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
                <div class="card-body">
                    {% if recent_playlists %}
                        <div class="row">
                            {% for playlist in recent_playlists %}
                                <div class="col-lg-4 col-md-6 mb-3">
                                    <div class="card h-100">
                                        {% if playlist.photo %}
                                            <img src="{{ playlist.photo.url }}" class="card-img-top" alt="{{ playlist.name }}" style="height: 150px; object-fit: cover;">
                                        {% else %}
                                            <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center" style="height: 150px;">
                                                <i class="fas fa-playlist fa-3x text-white"></i>
                                            </div>
                                        {% endif %}
                                        
                                        <div class="card-body d-flex flex-column">
                                            <h6 class="card-title">{{ playlist.name }}</h6>
                                            <p class="card-text text-muted">
                                                <small>
                                                    <i class="fas fa-music me-1"></i>{{ playlist.tracks.count }} треков
                                                </small>
                                            </p>
                                            <div class="mt-auto">
                                                <a href="{% url 'music:playlist_detail' playlist.pk %}" class="btn btn-outline-primary btn-sm w-100">
                                                    <i class="fas fa-eye me-1"></i>Просмотр
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-playlist fa-2x mb-2"></i>
                            <p>У вас пока нет плейлистов</p>
                            <a href="{% url 'music:create_playlist' %}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Создать плейлист
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Активность -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="h5 mb-0">
                        <i class="fas fa-history me-2"></i>Недавняя активность
                    </h3>
                </div>
                <div class="card-body">
                    {% if recent_activity %}
                        <div class="timeline">
                            {% for activity in recent_activity %}
                                <div class="timeline-item d-flex mb-3">
                                    <div class="timeline-icon me-3">
                                        <i class="fas fa-circle text-primary"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <p class="mb-1">{{ activity.description }}</p>
                                        <small class="text-muted">{{ activity.timestamp|date:"d.m.Y H:i" }}</small>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-history fa-2x mb-2"></i>
                            <p>Пока нет активности</p>
                            <p class="small">Ваши действия будут отображаться здесь</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function editProfile() {
    // Здесь можно добавить логику редактирования профиля
    alert('Функция редактирования профиля будет добавлена позже');
}

function changePassword() {
    // Здесь можно добавить логику смены пароля
    alert('Функция смены пароля будет добавлена позже');
}

function playTrack(trackId) {
    // Здесь можно добавить логику воспроизведения трека
    alert('Воспроизведение трека');
}

function removeFromFavorites(trackId) {
    if (confirm('Убрать трек из избранного?')) {
        // Здесь можно добавить логику удаления из избранного
        alert('Трек убран из избранного');
    }
}

function toggleAdminRole() {
    if (confirm('Вы уверены, что хотите изменить роль пользователя?')) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        console.log('CSRF Token:', csrfToken);
        
        fetch('{% url "music:toggle_admin_role" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                // Обновляем текст кнопки и бейдж роли
                const toggleText = document.getElementById('toggleAdminText');
                const roleBadge = document.querySelector('.badge');
                
                if (data.new_role === 'admin') {
                    toggleText.textContent = 'Убрать админ права';
                    roleBadge.textContent = 'Администратор';
                    roleBadge.className = 'badge bg-danger align-middle ms-2';
                    
                    // Показываем кнопку админ панели если её нет
                    const adminPanelBtn = document.querySelector('a[href*="admin-panel"]');
                    if (!adminPanelBtn) {
                        const buttonContainer = document.querySelector('.d-grid.gap-2');
                        const newAdminBtn = document.createElement('a');
                        newAdminBtn.href = '{% url "music:admin_panel" %}';
                        newAdminBtn.className = 'btn btn-outline-success';
                        newAdminBtn.innerHTML = '<i class="fas fa-cog me-2"></i>Админ панель';
                        buttonContainer.appendChild(newAdminBtn);
                    }
                } else {
                    toggleText.textContent = 'Сделать администратором';
                    roleBadge.textContent = 'Пользователь';
                    roleBadge.className = 'badge bg-secondary align-middle ms-2';
                    
                    // Скрываем кнопку админ панели
                    const adminPanelBtn = document.querySelector('a[href*="admin-panel"]');
                    if (adminPanelBtn) {
                        adminPanelBtn.remove();
                    }
                }
                
                alert(data.message);
            } else {
                alert('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка смены роли:', error);
            alert('Ошибка при изменении роли');
        });
    }
}
</script>

<style>
.profile-avatar img {
    border: 4px solid #fff;
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.15);
}

.timeline {
    position: relative;
}

.timeline-item {
    position: relative;
}

.timeline-icon {
    flex-shrink: 0;
    width: 20px;
    text-align: center;
}

.timeline-icon .fas {
    font-size: 0.5rem;
}

.timeline-content {
    flex-grow: 1;
}

.card {
    border-radius: 0.75rem;
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    border-radius: 0.75rem 0.75rem 0 0 !important;
}

.border-end {
    border-right: 1px solid #dee2e6 !important;
}

.badge {
    font-size: 0.75rem;
}

.table th {
    border-top: none;
    font-weight: 600;
}

.btn {
    border-radius: 0.5rem;
}
</style>
{% endblock %}
